# Calliope - AI 分步式长篇写作智能体

Calliope 是一个基于大语言模型（LLM）的交互式写作助手，专为长篇内容创作设计。它模拟专业作家的分步骤工作流程（规划 -> 研究 -> 大纲 -> 撰写 -> 修订），并结合了先进的 **GraphRAG（图谱增强检索）** 与向量 RAG 技术，确保长篇故事或报告在逻辑、设定和人物关系上的一致性。

## ✨ 核心特性

*   **全流程写作工作流:** 将复杂的长篇写作拆解为独立且可控的阶段：
    *   **📋 规划 (Planner):** 分析需求，制定整体创作蓝图。
    *   **🔍 研究 (Researcher):** **并行化**调用 Tavily / Google Search，极速整理素材。
    *   **📝 大纲 (Outliner):** 生成结构化大纲，支持层级调整。
    *   **✍️ 撰写 (Drafter):** **流式生成**章节，自动检索核心设定和前文摘要。
    *   **🎨 修订 (Refiner):** 全文润色，基于全书上下文优化文笔和连贯性。
*   **高级 GraphRAG 系统 (Phase 3):** 
    *   **实体关系提取**: 自动从世界观和章节中识别人物、地点及复杂关系。
    *   **多跳深度检索**: 写作时不仅检索直接关联，还能通过图谱发现二度关联（如“敌人的盟友”）。
    *   **冲突自动预警**: 实时检测新提取的关系是否与既有设定矛盾（如身份冲突、位置冲突）。
    *   **在线图形编辑器**: 提供交互式 UI，支持手动增删改实体节点与关系边，实现“人工干预”下的知识修正。
    *   **交互式可视化**: 基于 `streamlit-agraph` 的球形关系网，支持节点拖拽、缩放和派系着色。
*   **Writer-Critic 协作模式:** 
    *   内置“**AI 评论员 (Critic)**”角色，提供专业的编辑反馈。
    *   支持**一键采纳建议**，自动重写大纲或章节，形成“写作-评审-修改”的高效闭环。
*   **卓越的性能体验:**
    *   **流式输出 (Streaming)**: 响应零延迟，文字逐字蹦出。
    *   **并行搜索**: 多个搜索指令并发执行，效率提升 300% 以上。
    *   **智能缓存**: 基于 Streamlit `cache_resource` 优化重型模型（如重排序器）的加载。

## 🚀 技术栈

*   **核心框架:** Python 3.9+, LangChain (LCEL)
*   **Web 界面:** Streamlit, Streamlit-Agraph (交互图谱)
*   **知识存储:** ChromaDB (向量), NetworkX (图谱)
*   **RAG 增强:** `sentence-transformers` (Re-ranking)
*   **工具集成:** Tavily API, Google Custom Search API

## 🛠️ 安装与运行

### 1. 克隆项目与创建环境
```bash
git clone https://github.com/wxxzy/calliope.git
cd calliope
python -m venv venv
source venv/bin/activate  # Windows: .\venv\Scripts\activate
```

### 2. 安装依赖
```bash
pip install -r requirements.txt
```

### 3. 配置环境变量 (.env)
复制 `.env.example` 并填入您的 OpenAI/Google/Tavily API Key。

### 4. 启动应用
```bash
streamlit run app.py
```

## 📖 使用指南

1.  **项目管理:** 在侧边栏创建项目。系统会自动在 `data/` 下初始化向量库和关系图谱。
2.  **设定世界观:** 在“核心记忆”中输入设定，点击更新后，系统会同时索引向量库并**提取初始图谱**。
3.  **循序渐进创作:**
    *   **Step 1-3**: 依次完成规划、研究和大纲。每个阶段都可调用 **AI 评审**。
    *   **Step 4 (撰写)**: 点击“撰写章节”。系统执行**双路检索**（向量+图谱），确保设定不“掉线”。
    *   **Step 4.5 (迭代)**: 对不满意的章节，输入优化指令或根据评论员意见**重写本章**。
4.  **图谱管理**: 进入“**关系图谱**” Tab，查看自动生成的派系和关系网。
    *   **审核与预警**: 系统会自动标记与现有设定冲突的新关系，您可以手动选择采纳或舍弃。
    *   **在线编辑**: 您可以直接在数据表中修正错别字、修改关系类型，或手动添加 AI 未识别的关键设定。

## 📝 待办清单 (Roadmap)

*   [x] **多智能体协作:** 引入“评论员”角色及 Writer-Critic 循环。
*   [x] **知识图谱 3.0:** 实现冲突自动预警、交互可视化与在线编辑功能。
*   [ ] **导出功能:** 支持一键导出为 Markdown, PDF 或 EPUB 电子书。
*   [ ] **非线性叙事支持:** 引入元数据时间轴过滤，支持倒叙与多线叙事。

---
**License:** MIT
