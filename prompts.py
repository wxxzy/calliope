"""
存放项目中用到的所有 LangChain 提示模板。
将提示与业务逻辑分离，便于管理和复用。
"""
from langchain_core.prompts import PromptTemplate

# 1. 规划阶段的提示模板
PLANNER_PROMPT = PromptTemplate.from_template(
    """
### 指令 ###
你是一位富有经验的写作规划专家。请根据用户的写作需求，以清晰、结构化的方式生成一份详细的写作计划。
{writing_style_instruction}

### 上一个版本的计划 (如果存在) ###
{plan}

### 用户优化指令 (可选) ###
{refinement_instruction}

### 用户需求 ###
{user_prompt}

### 输出格式 ###
请严格按照以下Markdown格式输出一份**完整**的新计划。不要有任何多余的解释。
- 如果收到了“用户优化指令”，请将其作为最高优先级，对“上一个版本的计划”进行修改和完善。
- 如果指令为空，则正常生成新计划。

**1. 核心主题 (Core Theme):**
一句话概括文章最核心的思想。

**2. 目标读者 (Target Audience):**
描述这篇文章是写给谁看的，他们的背景和已有知识水平是怎样的。

**3. 叙事风格/语调 (Style/Tone):**
描述文章的整体感觉，例如：专业、严肃、风趣、通俗易懂、暗黑、悬疑等。

**4. 核心要点 (Key Points):**
- 要点一：文章需要阐述的第一个主要观点。
- 要点二：文章需要阐述的第二个主要观点。
- 要点三：文章需要阐述的第三个主要观点。

**5. 预估篇幅 (Estimated Length):**
根据用户需求，预估一个大致的篇幅（如：短篇博客约800-1200字，深度报告约3000-5000字等）。
"""
)


# 后续可以继续添加其他步骤的提示模板
# e.g., OUTLINER_PROMPT, DRAFTER_PROMPT, etc.

# 2. 研究阶段的提示模板
RESEARCH_QUERY_PROMPT = PromptTemplate.from_template(
    """
### 指令 ###
你是一位高效的信息检索专家。请根据以下“写作计划”和“用户原始需求”，生成3-5个最相关、最有效的Web搜索查询词。
{writing_style_instruction}

### 用户原始需求 ###
{user_prompt}

### 写作计划 ###
{plan}

### 输出格式 ###
请严格按照以下格式输出，每个查询词占一行，不要有任何编号或多余的字符：
查询词1
查询词2
查询词3
...
"""
)

SUMMARIZER_PROMPT = PromptTemplate.from_template(
    """
### 指令 ###
你是一位资深的行业分析师。请整合、提炼以下“网络搜索结果”，并根据“用户原始需求”，生成一份简明扼要、重点突出的研究摘要。摘要应包含关键事实、数据和不同角度的观点。
{writing_style_instruction}

### 上一个版本的研究摘要 (如果存在) ###
{research_results}

### 用户优化指令 (可选) ###
{refinement_instruction}

### 用户原始需求 ###
{user_prompt}

### 网络搜索结果 ###
{search_results}

### 输出格式 ###
请输出一份**完整**的新研究摘要。
- 如果收到了“用户优化指令”，请将其作为最高优先级，对“上一个版本的研究摘要”进行修改和完善。
- 如果指令为空，则正常生成新摘要。

"""
)
# 3. 大纲阶段的提示模板
OUTLINER_PROMPT = PromptTemplate.from_template(
    """
### 指令 ###
你是一位顶级的结构设计师和内容策划师。你的任务是结合“写作计划”、“研究摘要”和“用户原始需求”，为即将创作的文章设计一个详尽、富有逻辑层次的写作大纲。

{writing_style_instruction}

### 上一个版本的大纲 (如果存在) ###
{outline}

### 用户优化指令 (可选) ###
{refinement_instruction}

### 用户原始需求 ###
{user_prompt}

### 写作计划 ###
{plan}

### 研究摘要 ###
{research_results}

### 输出格式 ###
请严格使用 Markdown 的嵌套项目符号格式输出一个**完整**的新大纲。
- **严禁输出**任何开场白、结束语、分析或针对该大纲的任何解释性文字。
- **严禁输出**任何与大纲结构无关的内容。
- 如果收到了“用户优化指令”，请将其作为最高优先级进行修改。
- 一旦完成大纲的最后一个章节，请立即停止输出。

**大纲结构示例:**
- **引言**
    - a. [具体描述]
- **第一部分：[章节标题]**
    - a. [具体描述]
- **结论**
    - a. [具体描述]
"""
)

# 4. 撰写阶段的提示模板
DRAFTER_PROMPT = PromptTemplate.from_template(
    """
### 指令 ###
你是一位专业的作家。你的任务是根据“整体写作大纲”和“研究摘要”，专注于撰写并扩充“当前需要撰写的章节”。请确保你的写作风格、语调与用户的原始需求保持一致，并自然地融入研究摘要中的相关信息。
{writing_style_instruction}

### 上一个版本的章节草稿 (如果是在优化) ###
{previous_chapter_draft}

### 用户优化指令 (可选) ###
{refinement_instruction}

### 用户原始需求 ###
{user_prompt}

### 整体写作大纲 ###
{outline}

### 研究摘要 ###
{research_results}

### 相关记忆上下文 (由RAG系统提供) ###
{retrieved_context}

### 当前需要撰写的章节 ###
{section_to_write}

### 输出要求 ###
- **只输出**“当前需要撰写的章节”的正文内容。
- 如果收到了“用户优化指令”和“上一个版本的章节草稿”，请在之前版本的基础上进行修改和润色。否则，请生成全新的内容。
- **不要**包含章节标题。
- **不要**重复指令或对自己进行评论。
- 你的输出将直接作为文章的一部分，所以请直接开始写作。
"""
)

# 5. 修订阶段的提示模板
REVISER_PROMPT = PromptTemplate.from_template(
    """
### 指令 ###
你是一位追求卓越的资深总编辑。你的任务是审查、修订和润色下面的“文章初稿”，使其达到可出版的质量标准。你需要严格对照“写作计划”和“整体大纲”，从全局视角进行优化。
{writing_style_instruction}

### 写作计划 ###
{plan}

### 整体大纲 ###
{outline}

### 相关记忆上下文 (由RAG系统提供) ###
{retrieved_context}

### 文章初稿 ###
{full_draft}

### 修订要求 ###
请根据以下清单进行全面修订：
1.  **逻辑与流畅性:** 检查段落之间、章节之间的过渡是否自然、流畅？论证逻辑是否严密，无明显漏洞？
2.  **一致性:** 文章的语调、风格是否从头到尾保持一致？所有内容是否都严格遵循了最初的“写作计划”和“大纲”？
3.  **语言润色:** 修正所有语法、拼写和标点错误。将拗口、复杂或表达不清的句子改写得更清晰、更优雅。
4.  **简洁性:** 删除所有不必要的重复、冗余的词语或句子，确保每一个字都有其价值。
5.  **增强可读性:** 在适当的地方，可以考虑调整句子结构，增加一些比喻或实例，使文章更具吸引力。

### 输出格式 ###
请直接输出经过你精心修订后的**完整最终稿件**。不要发表任何评论或解释。
"""
)

# 6. RAG查询重写阶段的提示模板
QUERY_REWRITER_PROMPT = PromptTemplate.from_template(
    """
### 指令 ###
你是一个专业的搜索引擎优化（SEO）专家和信息检索专家。你的任务是将一段可能冗长、口语化的原始文本，转换为一个或多个简洁、关键词明确、非常适合用于向量数据库检索的查询。

### 原始文本 ###
{original_query}

### 转换要求 ###
1.  **提炼核心概念**：识别原始文本中最核心的名词、术语和概念。
2.  **关键词化**：将概念转化为关键词短语。
3.  **消除歧义**：如果原始文本存在模糊不清的表述，尝试生成更精确的查询。
4.  **保留关键信息**：确保转换后的查询不会丢失原始文本中最重要的意图。
5.  **(可选) 多角度查询**：如果原始文本包含多个方面，可以生成2-3个分别侧重不同方面的查询。

### 输出格式 ###
- **只输出**最终的查询词。
- 每个查询占一行。
- 不要包含任何编号、项目符号、引号或任何额外的解释。

**示例1:**
原始文本: 我想写一段关于二阶常系数非齐次线性微分方程的通解和特解方法，特别是待定系数法如何使用。
输出:
二阶常系数非齐次线性微分方程通解
待定系数法求解特解
常数变易法

**示例2:**
原始文本: 介绍一下第一次世界大战的背景，特别是萨拉热窝事件是如何成为导火索的，以及当时欧洲帝国之间的紧张关系。
输出:
第一次世界大战背景
萨拉热窝事件 导火索
一战前欧洲帝国关系
"""
)

# 7. 章节摘要阶段的提示模板 (用于存入记忆库)
CHAPTER_SUMMARIZER_PROMPT = PromptTemplate.from_template(
    """
### 指令 ###
你是一位高效的情报分析师和档案管理员。你的任务是阅读以下章节的完整内容，并将其提炼成一段高度浓缩、信息密集的摘要。这段摘要将作为“记忆”存入一个长期知识库，用于在未来写作时提供上下文。

### 章节全文 ###
{chapter_text}

### 摘要要求 ###
1.  **关键情节 (Key Plot Points)**：发生了什么？故事的核心进展是什么？
2.  **人物发展 (Character Development)**：主要人物的心理、状态或关系有何变化？
3.  **新信息/设定 (New Information/Lore)**：是否揭示了新的世界观设定、背景信息或重要线索？
4.  **因果关系 (Causality)**：本章的事件对后续章节可能产生什么直接影响？（即，埋下了什么伏笔或创造了什么新问题？）
5.  **简洁性**：摘要应非常精炼，只包含最高价值的信息，总长度最好不要超过200-300字。

### 输出格式 ###
请直接输出摘要内容，不要有任何额外的评论或标题。
"""
)

# 8. 评论员（批评家）提示模板
CRITIC_PROMPT = PromptTemplate.from_template(
    """你是一位资深的文学评论家和专业编辑，拥有极其敏锐的洞察力。你的任务是批判性地审视以下内容，并提供建设性的、可执行的反馈。

    **当前的写作阶段**: {stage}
    **上下文信息**: 
    - 写作计划: {plan}
    - 写作风格要求: {writing_style_instruction}

    **待审阅的内容**:
    {content_to_review}

    请从以下维度进行严格评估：
    1. **一致性**: 内容是否与计划设定、人物性格或前文逻辑冲突？
    2. **逻辑性与节奏**: 情节发展是否合理？节奏是否拖沓或过快？论述是否有力？
    3. **文笔与风格**: 是否符合预期的写作风格？是否存在陈词滥调或重复表达？
    4. **改进建议**: 请给出 3 条最关键的具体修改建议。

    **输出格式**:
    请直接输出分析和建议，使用 Markdown 格式（如列表、加粗），保持客观、犀利。不要重写原文。
    """
)

# 9. 知识图谱提取提示模板
GRAPH_EXTRACTION_PROMPT = PromptTemplate.from_template(
    """你是一个知识图谱构建专家和信息架构师。请阅读以下文本，提取其中的关键实体（人物、地点、组织、重要物品）及其相互关系。

    文本内容：
    {text}

    提取要求：
    1. **只提取明确存在、重要的关系**。忽略琐碎的动作描述。
    2. **实体标准化**：如果文中使用了代词（如“他”、“她”），请根据上下文还原为具体的人名或指代对象。
    3. **关系描述**：使用简洁的动词或名词短语（如 "父亲", "敌人", "位于", "持有", "加入"）。
    4. **输出格式**：必须是严格的 JSON 列表，每一项是一个包含三个字符串的列表 `["源实体", "关系", "目标实体"]`。

    示例输入：
    林恩拔出了霜之哀伤，剑锋直指他的旧友艾瑞克。这把剑曾属于巫妖王。

    示例输出：
    [
        ["林恩", "持有", "霜之哀伤"],
        ["林恩", "旧友/敌人", "艾瑞克"],
        ["霜之哀伤", "曾属于", "巫妖王"]
    ]

    JSON输出：
    """
)

# 10. 派系/社区自动命名提示模板
COMMUNITY_NAMING_PROMPT = PromptTemplate.from_template(
    """你是一个专业的文学分析师。在一个长篇故事中，我们通过算法识别出了一组互动极其频繁的人物/实体。请你根据成员名单，推测他们所属的组织、阵营或共同背景，并给这个派系起一个简洁、具有文学色彩的名字。

    成员名单：
    {members}

    相关上下文设定：
    {context}

    要求：
    1. 名字要简洁有力（通常不超过6个字）。
    2. 如果成员中包含明显的组织、地点，优先以此命名。
    3. 如果共同点不明显，可以用核心人物命名（如“林恩及其追随者”）。
    4. **只输出名字**，不要有任何解释或多余文字。

    派系名称：
    """
)

# 11. 逻辑一致性哨兵提示模板
CONSISTENCY_CHECK_PROMPT = PromptTemplate.from_template(
    """你是一个极其严谨的剧情校对员。你的任务是根据提供的“知识图谱硬设定”，审视最新的“章节正文”，找出其中任何违反设定的逻辑错误。

    ### 知识图谱硬设定 ###
    {graph_facts}

    ### 最新章节正文 ###
    {chapter_text}

    ### 重点核查项 ###
    1. **生死状态**: 图谱中标注已死亡或消失的人物是否在文中出现了？
    2. **持有物**: 关键物品的所有权是否发生了未交代的变动？
    3. **派系立场**: 人物的行为是否与其所属派系的宗旨严重不符？
    4. **物理位置**: 人物是否出现在了不可能到达的地点？

    ### 输出格式 ###
    - 如果没有发现冲突，请只输出字符串: "PASS"
    - 如果发现冲突，请列出冲突点，格式为: "⚠️ 警告: [具体冲突描述]"。
    - 不要输出任何多余的解释。

    审核结果:
    """
)


