import streamlit as st
import logging
import re
from datetime import datetime
from config import load_environment
import config_manager
import vector_store_manager
import workflow_manager
import state_manager
import logger_config
from custom_exceptions import LLMOperationError, ToolOperationError, VectorStoreOperationError, ConfigurationError

# å¼•å…¥ UI ç»„ä»¶
from ui_components.writer_view import render_writer_view
from ui_components.explorer_view import render_explorer_view
from ui_components.graph_view import render_graph_view
from ui_components.config_view import render_config_view
from core.project_manager import ProjectManager

# --- åˆå§‹åŒ– ---
load_environment()
logger_config.setup_logging()
app_logger = logging.getLogger(__name__)

st.set_page_config(page_title="Calliope AI å†™ä½œ", page_icon="ğŸ“š", layout="wide")

# å®šä¹‰éœ€è¦æŒä¹…åŒ–ä¿å­˜çš„ Session State é”®å
SAVE_KEYS = [
    'project_name', 'collection_name', 'world_bible', 'plan', 
    'research_results', 'outline', 'drafts', 'drafting_index', 
    'final_manuscript', 'outline_sections', 'user_prompt', 
    'selected_tool_id', 'full_draft', 'project_writing_style_id', 
    'project_writing_style_description', 'retrieved_docs',
    'current_critique', 'critique_target_type'
]

def reset_project_state():
    """é‡ç½®ç‰¹å®šé¡¹ç›®ç›¸å…³çš„çŠ¶æ€"""
    keys_to_reset = SAVE_KEYS + ['pending_triplets']
    for key in keys_to_reset:
        if key in st.session_state: del st.session_state[key]

def save_and_snapshot():
    """ç»Ÿä¸€æ‰§è¡Œä¿å­˜å’Œåˆ›å»ºå¿«ç…§çš„é€»è¾‘"""
    if 'collection_name' in st.session_state:
        # 1. å†…å­˜åŒæ­¥åˆ°ç£ç›˜ (Save)
        data_to_save = {k: st.session_state[k] for k in SAVE_KEYS if k in st.session_state}
        if state_manager.save_state_to_file(st.session_state.collection_name, data_to_save):
            # 2. åˆ›å»ºå¤‡ä»½å‰¯æœ¬ (Snapshot)
            ProjectManager.create_snapshot(st.session_state.collection_name)
            st.session_state.last_save_time = datetime.now().strftime("%H:%M:%S")
            return True
    return False

def run_step_with_spinner(step_name: str, spinner_text: str, full_config: dict):
    """å¸¦ Spinner çš„æ­¥éª¤è¿è¡ŒåŒ…è£…å™¨ (ä¼ é€’ç»™ç»„ä»¶ä½¿ç”¨)"""
    style_desc = st.session_state.get('project_writing_style_description', '')
    output_placeholder = st.empty()
    full_response = ""

    def stream_callback(chunk):
        nonlocal full_response
        full_response += chunk
        output_placeholder.markdown(full_response + "â–Œ")

    with st.spinner(spinner_text):
        try:
            result = workflow_manager.run_step(
                step_name, st.session_state, full_config, style_desc, stream_callback=stream_callback
            )
            if full_response: output_placeholder.markdown(full_response)
            else: output_placeholder.empty()
            
            # --- è‡ªåŠ¨ä¿å­˜é€»è¾‘ ---
            # å®šä¹‰å“ªäº›æ­¥éª¤æˆåŠŸåéœ€è¦è‡ªåŠ¨ä¿å­˜
            critical_steps = ["plan", "outline", "generate_draft", "generate_revision", "update_bible"]
            if step_name in critical_steps:
                save_and_snapshot()
                st.toast(f"âœ… è¿›åº¦å·²è‡ªåŠ¨ä¿å­˜å¹¶åˆ›å»ºå¿«ç…§ ({st.session_state.last_save_time})")

            st.success(f"æ­¥éª¤ '{step_name}' å®Œæˆï¼")
            return result
        except (LLMOperationError, ToolOperationError, VectorStoreOperationError, ConfigurationError) as e:
            output_placeholder.empty()
            st.error(str(e))
            return None
        except Exception as e:
            output_placeholder.empty()
            st.error(f"æœªçŸ¥é”™è¯¯: {e}")
            app_logger.error(f"Error in {step_name}: {e}", exc_info=True)
            return None

def main():
# ... (main å‡½æ•°çš„å‰©ä½™éƒ¨åˆ†æˆ‘å°†ä¿ç•™) ...
